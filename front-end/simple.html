<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="width=device-width, initial-scale=1.0; text/html; charset=utf-8"/>
    <title>FaaS</title>
    <meta name="author" content="Alvaro Trigo Lopez"/>
    <meta name="description" content="fullPage very simple demo."/>
    <meta name="keywords" content="fullpage,jquery,demo,simple"/>
    <meta name="Resource-type" content="Document"/>


    <link rel="stylesheet" type="text/css" href="jquery.fullPage.css"/>
    <link rel="stylesheet" type="text/css" href="examples.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://unpkg.com/file-upload-with-preview/dist/file-upload-with-preview.min.css">

	<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<!--<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <script type="text/javascript" src="scrolloverflow.js"></script>
	<script src="https://unpkg.com/file-upload-with-preview"></script>
	<link rel="stylesheet" media="(min-width: 568.01px)" href="hori_display.css">
	<link rel="stylesheet" media="(max-width: 568px)" href="vert_display.css">
	<link rel="stylesheet"
		  media="(max-device-width: 768px) and (orientation: portrait)"
		  href="vert_display.css">
	<link rel="stylesheet"
		  media="(max-device-width: 768px) and (orientation: landscape)"
		  href="hori_display.css">

    <script type="text/javascript" src="jquery.fullPage.js"></script>
    <script type="text/javascript">
        // 请求用到的参数
        var Bucket = 'imgps-1254095611';
        var Region = 'ap-guangzhou';
        var protocol = location.protocol === 'https:' ? 'https:' : 'http:';
        var prefix = protocol + '//' + Bucket + '.cos.' + Region + '.myqcloud.com/';
        var file;
        // 计算签名
        var getAuthorization = function (options, callback) {
            var method = (options.Method || 'get').toLowerCase();
            var key = options.Key || '';
            // var url = 'http://127.0.0.1:3000/sts-post-object' +
            var url = 'http://111.230.168.122/server/sts-post-object.php' +
                '?method=' + method +
                '&pathname=' + encodeURIComponent('/') +
                '&key=' + encodeURIComponent(key);
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onload = function (e) {
                var data = JSON.parse(e.target.responseText);
                if (data.authorization === '') {

                }
                callback(null, {
                    Authorization: data.authorization,
                    XCosSecurityToken: data.sessionToken,
                });
            };
            xhr.onerror = function (e) {
                callback('获取签名出错');
            };
            xhr.send();
        };

        var address;

        var uploadFile=function (file, callback) {
            address = "http://imgp-1254095611.cosgz.myqcloud.com/"+file.name;
            var Key = file.name;
            getAuthorization({Method:'POST',Key:Key},function (err,info) {
                var auth = info.Authorization;
                var XCosSecurityToken=info.XCosSecurityToken;
                var fd=new FormData();
                fd.append('key',Key);
                fd.append('Signature',auth);
                XCosSecurityToken && fd.append('x-cos-security-token', XCosSecurityToken);
                fd.append('file',file);
                var url=prefix;
                var xhr=new XMLHttpRequest();
                xhr.open('POST',url,true);
                xhr.onload=function () {
                    if(Math.floor(xhr.status/100)===2){
                        var ETag=xhr.getResponseHeader('etag');
                        callback(null,{url:url,ETag:ETag});
                    }
                    else
                    {
                        callback('File'+Key+'Upload Failed, status code:'+xhr.status);
                    }
                };
                xhr.onerror=function () {
                    callback('File'+Key+'Upload failed. Please check if CORS cross domain rules are not configured.')
                };
                xhr.send(fd);

            });
        }




        $(document).ready(function () {
            $('#fullpage').fullpage({
                sectionsColor: ['#f2f2f2', '#4BBFC3', '#7BAABE', 'whitesmoke', '#ccddff']
                //anchors:['firstPage', 'secondPage', 'thirdPage','fourthPage']
            });
            // var requestURL="http://my.liziwl.cn:5000/sign";
            // $('#zoom_file').click()
            // {
            //     console.log('gg');
            //     $.getJSON( requestURL, function( data ){
            //         console.log('gg2');
            //         // console.log(data);
            //         data = JSON.parse(data);
            //         console.log(data);
            //         console.log(data['data']['credentials']); // Logs "jQuery Howto"
            //     });
            //     $.ajax({
            //         //此处填写服务器地址
            //         url:"guangzhou.file.myqcloud.com",
            //         type: 'POST',
            //         cache: false,
            //         data: {
            //             "Authorization":"SU7vzQeHgWVssbsDFJ5xhtcqGVxhPTEyNTQwOTU2MTEmYj1pbWcmaz1BS0lEcFpEeUJLNkJwTWoxREQ4VVNKZ085a0hlcHBlSHd5NDUmZT0xNTIzNzE0ODQ2JnQ9MTUyMzExMDA0NiZyPTIyNjczMjc4OCZmPQ==",
            //             "":new FormData($('#zoom_file_upload')[0])
            //         },
            //         processData: false,
            //         contentType: false,
            //
            //     })
            // }



            var status_code;
            $('#cut_upload_file').click(function () {
                file=document.getElementById('zoom_file').files[0];
                if(!file)
                {
                    alert("Please choose a picture");
                    // document.getElementById('slide1').innerText='Do not choose the upload file';
                    return;
                }
                file && uploadFile(file, function (err,data) {
                    console.log(err||data);
                    uploadFile(file, callback());
                    alert("function");
                    alert('Upload Successfully');
                    // document.getElementById('slide1').innerText=err?err:('Upload Successfully'+data.ETag);

                });

                    $.ajax({
                        url: address,
                        success: function () {
                          status_code = 200;
                          alert("Finish Process");
                        },

                    });

            });

            $('#cut_download_file').click(function () {
                if(status_code == 200 )
                {


                    downloadURI(address, file.name);
                    // address="'"+address+"'";
                    $("#cut_preview_image").attr("src", address);
                }
                else
                {
                    alert(status_code);
                    alert("The process do not finish yet.");
                }


            });

        });
        function downloadURI(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link;
        }
	</script>


</head>
<body style="font-family: Lato, arial, 'Microsoft YaHei UI', serif;">
<div id="fullpage">
    <div class="section active" id="section0">
        <h1 id="section0_title">FaaS</h1>
        <h2 id="section0_comment">为您处理好每一张图片</h2>
    </div>
    <div class="section" id="section1">
        <div class="slide active" id="slide1">
            <div class="container">
                <h1 id="slide1_title" style="color: #ffffff;">图片剪圆角</h1>
                <div class="custom-file-container" data-upload-id="myUniqueUploadId">
                    <label style="display: none;">Upload File <a href="javascript:void(0)"
                                                                 class="custom-file-container__image-clear"
                                                                 title="Clear Image">x</a></label>
                    <label class="custom-file-container__custom-file" id="file_control_bar">
                        <input type="file" class="custom-file-container__custom-file__custom-file-input"
                               style="height: 100%;" accept="image/*" id="zoom_file">
                        <input type="hidden" name="MAX_FILE_SIZE" value="10485760"/>
                        <span class="custom-file-container__custom-file__custom-file-control"
                              style="height: 100%; "></span>
                    </label>
                    <div>
                        <input class="control_btn" type="button" id="cut_upload_file" value="Process" style="background: #33d9b2">
                        <input class="control_btn" type="button" id="cut_download_file" value="Download" style="background: #34ace0">
                        <a href="#" id = "download_cut_file" onclick="prepHref(this)" download></a>
                        <input class="control_btn" type="button" id="cut_remove_file"value="Cancel" style="background: #ff5252">
                    </div>
                    <div class="row">
                        <div class="image_container custom-file-container__image-preview"></div>
                        <div class="image_container custom-file-container__image-preview"
                             style="border: solid 1px" id="download_preview" >
                            <img id="cut_preview_image" src="" alt="No image loaded"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="slide " id="first_slide"><h1>为图片加水印</h1></div>
            <div class="slide"><h1>为图片加二维码</h1></div>
            <div class="slide"><h1>压缩图片</h1></div>
            <div class="slide"><h1>待续。。。</h1></div>
        </div>
        <div class="section" id="section2"><h1>No wraps, no extra markup</h1></div>
        <div class="section" id="section3"><h1>Just the simplest demo ever</h1></div>
    </div>
</div>
<script src="https://unpkg.com/file-upload-with-preview"></script>
<script>
    var upload = new FileUploadWithPreview('myUniqueUploadId')
</script>
</body>
</html>