<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="width=device-width, initial-scale=1.0; text/html; charset=utf-8"/>
    <title>FaaS</title>
    <meta name="author" content="Alvaro Trigo Lopez"/>
    <meta name="description" content="fullPage very simple demo."/>
    <meta name="keywords" content="fullpage,jquery,demo,simple"/>
    <meta name="Resource-type" content="Document"/>

    <link rel="stylesheet" type="text/css" href="jquery.fullPage.css"/>
    <link rel="stylesheet" type="text/css" href="examples.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://unpkg.com/file-upload-with-preview/dist/file-upload-with-preview.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <script type="text/javascript" src="scrolloverflow.js"></script>
	<script src="https://unpkg.com/file-upload-with-preview"></script>
	<link rel="stylesheet" media="(min-width: 568.01px)" href="hori_display.css">
	<link rel="stylesheet" media="(max-width: 568px)" href="vert_display.css">
	<link rel="stylesheet"
		  media="(max-device-width: 768px) and (orientation: portrait)"
		  href="vert_display.css">
	<link rel="stylesheet"
		  media="(max-device-width: 768px) and (orientation: landscape)"
		  href="hori_display.css">

    <script type="text/javascript" src="jquery.fullPage.js"></script>
    <script type="text/javascript">
        // 请求用到的参数
        var Bucket = 'imgps-1254095611';
        var Region = 'ap-guangzhou';
        var protocol = location.protocol === 'https:' ? 'https:' : 'http:';
        var prefix = protocol + '//' + Bucket + '.cos.' + Region + '.myqcloud.com/';
        var file;
        // 计算签名
        var getAuthorization = function (options, callback) {
            var method = (options.Method || 'get').toLowerCase();
            var key = options.Key || '';
            var url = 'http://111.230.168.122/server/sts-post-object.php' +
                '?method=' + method +
                '&pathname=' + encodeURIComponent('/') +
                '&key=' + encodeURIComponent(key);
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onload = function (e) {
                var data = JSON.parse(e.target.responseText);
                if (data.authorization === '') {

                }
                callback(null, {
                    Authorization: data.authorization,
                    XCosSecurityToken: data.sessionToken
                });
            };
            xhr.onerror = function (e) {
                callback('获取签名出错');
            };
            xhr.send();
        };

        var address;
        var uploadFile=function (file, callback) {
            address = "http://imgp-1254095611.cosgz.myqcloud.com/"+file.name;
            var Key = file.name;
            getAuthorization({Method:'POST',Key:Key},function (err,info) {
                var auth = info.Authorization;
                var XCosSecurityToken=info.XCosSecurityToken;
                var fd=new FormData();
                fd.append('key',Key);
                fd.append('Signature',auth);
                XCosSecurityToken && fd.append('x-cos-security-token', XCosSecurityToken);
                fd.append('file',file);
                var url=prefix;
                var xhr=new XMLHttpRequest();
                xhr.open('POST',url,true);
                /*xhr.onload=function () {
                    if(Math.floor(xhr.status/100)===2){
                        var ETag=xhr.getResponseHeader('etag');
                        callback(null,{url:url,ETag:ETag});
                    }
                    else
                    {
                        callback('File'+Key+'Upload Failed, status code:'+xhr.status);
                    }
                };*/
                xhr.onerror=function () {
                    callback('File'+Key+'Upload failed. Please check if CORS cross domain rules are not configured.')
                };
                xhr.send(fd);
                var data = {
                    "requestContext": {
                        "serviceName": "round_corners",
                        "path": "/Image_process/round_corners",
                        "httpMethod": "POST",
                        "requestId": "",
                        "identity": {
                            "secretId": "AKIDUaaGn8oG8rPLNKsf2nPtFQTK0Ums6TyH"
                        },
                        "sourceIp": "10.0.2.14",
                        "stage": "prod"
                    },
                    "headers": {
                        "Accept-Language": "en-US,en,cn",
                        "Accept": "text/html,application/xml,application/json",
                        "Host": "service-mi2vlexs-1252063131.ap-guangzhou.apigateway.myqcloud.com",
                        "User-Agent": "User Agent String"
                    },
                    "body": "{\"Image_process\":\"body\"}",
                    "pathParameters": {
                        "cos":{
                            "cosSchemaVersion":"1.0",
                            "cosNotificationId":"233",
                            "cosBucket":{
                                "name":"input",
                                "appid":"1252063131",
                                "region":"gz"
                            },
                            "cosObject":{
                                "key":"/images-2.jpeg",
                                "size":"1024",
                                "meta":{
                                    "Content-Type": "",
                                    "x-cos-meta-test": "",
                                    "x-image-test": ""
                                },
                                "url": ""
                            }
                        }
                    },
                    "queryStringParameters": {
                        "rad":100
                    },
                    "headerParameters":{
                        "Refer": "10.0.2.14"
                    },
                    "stageVariables": {
                        "stage": "test"
                    },
                    "path": "",
                    "httpMethod": "POST"
                };
                data["pathParameters"]["cos"]["cosObject"]["key"]=file.name;
                var newData = JSON.stringify(data);
                var trigger_xhr=new XMLHttpRequest();
                trigger_xhr.open('POST','http://service-mi2vlexs-1252063131.ap-guangzhou.apigateway.myqcloud.com/Image_process/round_corners',true);
                trigger_xhr.onload = function () {
                    console.log('http://service-mi2vlexs-1252063131.ap-guangzhou.apigateway.myqcloud.com/Image_process/round_corners'); // http://example.com/test
                };
                trigger_xhr.send(newData);
            });
        };

        $(document).ready(function () {
            $('#fullpage').fullpage({
                sectionsColor: ['#f2f2f2', '#4BBFC3', '#7BAABE', 'whitesmoke', '#ccddff']
                //anchors:['firstPage', 'secondPage', 'thirdPage','fourthPage']
            });
            // var requestURL="http://my.liziwl.cn:5000/sign";
            // $('#zoom_file').click()
            // {
            //     console.log('gg');
            //     $.getJSON( requestURL, function( data ){
            //         console.log('gg2');
            //         // console.log(data);
            //         data = JSON.parse(data);
            //         console.log(data);
            //         console.log(data['data']['credentials']); // Logs "jQuery Howto"
            //     });
            //     $.ajax({
            //         //此处填写服务器地址
            //         url:"guangzhou.file.myqcloud.com",
            //         type: 'POST',
            //         cache: false,
            //         data: {
            //             "Authorization":"SU7vzQeHgWVssbsDFJ5xhtcqGVxhPTEyNTQwOTU2MTEmYj1pbWcmaz1BS0lEcFpEeUJLNkJwTWoxREQ4VVNKZ085a0hlcHBlSHd5NDUmZT0xNTIzNzE0ODQ2JnQ9MTUyMzExMDA0NiZyPTIyNjczMjc4OCZmPQ==",
            //             "":new FormData($('#zoom_file_upload')[0])
            //         },
            //         processData: false,
            //         contentType: false,
            //
            //     })
            // }

            var status_code;
            $('#round_upload').click(function () {
                file=document.getElementById('round_file').files[0];
                if(!file)
                {
                    alert("Please choose a picture");
                    // document.getElementById('slide1').innerText='Do not choose the upload file';
                    return;
                }
                file && uploadFile(file, function (err,data) {
                    console.log(err||data);
                    uploadFile(file, callback());
                    alert("function");
                    alert('Upload Successfully');
                    // document.getElementById('slide1').innerText=err?err:('Upload Successfully'+data.ETag);
                });
                    $.ajax({
                        url: address,
                        success: function () {
                          status_code = 200;
                            $("#round_preview").css("background-image", 'url(' + address + ')');
                          // $("#cut_preview_image").attr("src", address);
                          alert("Finish Process");
                        }
                    });
            });

            $('#round_download').click(function () {
                if(status_code === 200 )
                {
                    // address="'"+address+"'";
                    downloadURI(address, file.name);
                }
                else
                {
                    alert(status_code);
                    alert("The process do not finish yet.");
                }
            });
        });
        function downloadURI(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link;
        }
	</script>

</head>
<body style="font-family: Lato, arial, 'Microsoft YaHei UI', serif;">
<div id="fullpage">
    <div class="section active" id="section0">
        <h1 id="section0_title">FaaS</h1>
        <h2 id="section0_comment">为您处理好每一张图片</h2>
    </div>
    <div class="section" id="section1">
        <div class="slide active" id="slide1">
            <div class="container">
                <h1 class="slide_title">图片剪圆角</h1>
                <div class="custom-file-container" data-upload-id="myUniqueUploadId">
                    <label style="display: none;">Upload File <a href="javascript:void(0)"
                                                                 class="custom-file-container__image-clear"
                                                                 title="Clear Image">x</a></label>
                    <label class="custom-file-container__custom-file file_control_bar">
                        <input type="file" class="custom-file-container__custom-file__custom-file-input"
                               style="height: 100%;" accept="image/*" id="round_file">
                        <input type="hidden" name="MAX_FILE_SIZE" value="10485760"/>
                        <span class="custom-file-container__custom-file__custom-file-control"
                              style="height: 100%; padding: 0; "></span>
                    </label>
                    <div>
                        <input type="text" class="input_box" id = "round_input" placeholder="input the radius">
                        <input class="control_btn" type="button" id="round_upload" value="Upload" style="background: #33d9b2">
                        <input class="control_btn" type="button" id="round_download" value="Download" style="background: #34ace0">
                        <a href="#" onclick="prepHref(this)" download></a>
                        <!--<input class="control_btn" type="button" id="round_cancel"value="Cancel" style="background: #ff5252">-->
                    </div>
                    <div class="row">
                        <div class="image_container custom-file-container__image-preview"></div>
                        <div class="image_container custom-file-container__image-preview"
                             id="round_preview" style="background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAiQAAAD6CAMAAACmhqw0AAAA+VBMVEUAAAD29u3u7unt7ent7enu7uju7uihoqCio6Gio6KjpKOkpaSmpqSmp6WoqKaqq6mqq6qrq6qsrautrauur62wsa6xsa+xsrCys7GztLK0tbK1trS2t7S3t7W4uba5ure6u7e7vLm8vbu9vrvAwL3Awb3DxMHFxcPGxsPHx8TIycXLzMjLzMnMzMnNzsrPz8vP0MzQ0M3S0s/U1NDV1dLX19TY2NTY2NXZ2dba2tXb29bc3Nfc3Njc3dnd3dre3tre39vg4Nvh4dzi4t3i4t7j497k5N/k5ODl5eDl5eHl5uLm5uHn5+Lo6OPp6eTq6uXr6+bs7Oft7eh54KxIAAAAB3RSTlMAHKbl5uztvql9swAABA1JREFUeNrt3VlT01AYgOG0oEEE910URNzFBVFcqCgKirLU/P8fI3QYbEOSdtrMyJzzvHfMlFx833NBQuY0SRrN8UwqabzZSJLGaYNQVacaSdMUVF0zGTMEVTeWmIH6BYkgESSCRJAIEkEiSCRIBIkgESSCRJAIEkEiQSJIBIkgESSCRJAIEgkSQSJIBIkgESSCRJBIkAgSQSJIBIkgESSCRIJEkAgSQSJIBIkgkSARJIJEkAgSQSJIBIkEiSARJIJEkAgSQSJIJEgEiSARJIJEkAgSQSJBIkgEiSARJIJEkAgSCRJBIkgEiSARJIJEgkSQ5PvxbdS+tyEJuZVb0+noTV579geSQGs/SOvqxiYkYfYwra+rbUhC7NNEjUjSJ5CE2P06jaTnIAmxKwe7vb468t3N14WOki1IAuzMwWrf1HCh3Q6S95AEWGe1b0/WlSCBBBJIIAkdSXvt1aNXa21IICld7dJU5+epJUggKV7tzuzRA4/ZHUggKVrtfNdjsXlIIClY7XLPw9NlSCA5vtqLPUguQgLJsdX+zv0fZhsSSPKrXckhWSn5jV8zG5DEiuR1DsnrEiOX0vMbkESKZDWHZLXMSFqsBJIIkOz1vn40sVdqpFgJJDHc3dzsQXKzwkihEkhiQLI+2f3y+3qVkSIlkMSAJFvsQrJYbaRACSRRIMlenj0UcPZlPyPHlUASB5Jsc+7cwevMc5v9jRxTAkkkSPbb+riVZYMYySuBJB4kJRUYySmBJHYkhUZ6lUASOZISIz1KIIkbSamRbiWQxIZkvT2YkS4lkESGpDV9tz2YkX9KIIkLSWs6TY+U9DFypASSqJC0OicfHSrpa2T/k5BEh6R1eDpWR8kARtIZSGJD0jo6QW1fySBGIIkOSavrlL27PwcxAklsSFo9JzFOppBAkl9ta5jTOiGJCslQRiCJCslwRiCJCcmQRiCJCMmwRiCJB8mXoU+YhyQaJM9TSCCBBBJIIIEEEkgggQQSSCCJAsnyzLA9hiQWJCfnSpBAAgkkkATXxFCnPxfU7iB5B0mAXT5Y7Z3t0Y087SDZgCTA7tX6bZ5TGSQBtlwrkgVIgmy+RiMXdiEJsp3b9Rn5nEESaC/O1/P3yMJuBkm4bX94O2rvNiKbWXRIBIkgESSCRJAIEkEiQSJIBIkgESSCRJAIEgkSQSJIBIkgESSCRIJEkAgSQSJIBIkgESQSJIJEkAgSQSJIBIkgkSARJIJEkAgSQSJIBIkEiSARJIJEkAgSQSJIJEgEiSARJIJEkAgSCRJBIkgEiSARJIJEkEiQCBJBIkgEiSARJIJEgkSQCBJBIkgEiSARJBIkgkSQ6P8gGTMDVTeWNA1B1TWTxmlTUFWnGknSaI4bhMoabzaSv+4BHFVoHZzfAAAAAElFTkSuQmCC');">
                            <!--<img id="cut_preview_image" src="" alt="No image loaded"/>-->
                        </div>
                    </div>
                </div>
            </div>
            <div class="slide " id="first_slide">
                <h1 class="slide_title">为图片加水印</h1></div>
            <div class="slide">
                <h1 class="slide_title">为图片加二维码</h1></div>
            <div class="slide">
                <h1 class="slide_title">压缩图片</h1></div>
            <div class="slide">
                <h1 class="slide_title">待续。。。</h1></div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/file-upload-with-preview"></script>
<script>
    var upload = new FileUploadWithPreview('myUniqueUploadId')
</script>
</body>
</html>